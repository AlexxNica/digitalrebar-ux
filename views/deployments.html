<!--
deployments view
-->
<div>
	<md-card ng-repeat='(id, deployment) in _deployments' flex='100'>

		<!-- Top bar for each deployment -->
		<md-toolbar flex layout='column' ng-class="{'md-warn': deployments.deploymentStatus[deployment.id].error > 0}" ng-click="deployments.toggleExpand(deployment)" md-ink-ripple>
			<section layout='row'>
			<div class="md-toolbar-tools">
				<h2 class="md-flex">{{deployment.name}}</h2>
			</div>
			<span flex></span>

			<!-- Sparkline for the nodes -->
			<span spark class='inset' type='pie' ng-model="deployments.deploymentPie[deployment.id]" opts='{{deployments.opts}}'>
			</span>
			
			<!-- Expand button -->
			<span class='inset'>
				<md-button class="md-icon-button">
					<md-icon ng-hide="expand[deployment.id]">expand_more</md-icon>
					<md-icon ng-show="expand[deployment.id]">expand_less</md-icon>
				</md-button>
			</span>
			</section>

			<!-- Progress bar for roles, progress is the % of ready nodes-->
			<md-progress-linear md-mode="determinate" ng-class="{'md-warn': deployments.deploymentStatus[deployment.id].error > 0}" value="{{100*(1-deployments.deploymentStatus[deployment.id].error/deployments.deploymentStatus[deployment.id].total)}}"
			></md-progress-linear>

		</md-toolbar>

		<!-- Tabs that appear after the expand button is pressed -->
		<section ng-slide-down='expand[deployment.id]' duration='0.5'>
			
			<md-tabs md-dynamic-height md-border-bottom md-stretch-tabs="always" >

				<!-- Nodes tab -->
				<md-tab label="Nodes">
						<!-- Add all the nodes as list items -->
						<span ng-repeat="node in _nodes | from:'deployment':deployment | filter:{system: false} | orderBy: 'name'">
							<!-- Node button -->
							<md-button class="md-fab md-primary md-mini" md-theme="status_{{node.status}}" ng-href="#/nodes/{{node.id}}">
								<md-tooltip md-direction="bottom">
									{{node.name}}
								</md-tooltip>
								<md-icon aria-label='{{node.status}}'>{{icons[node.status]}}</md-icon>
							</md-button>

						</span>

				</md-tab>

				<!-- Roles tab -->
				<md-tab label="Roles">

					<!-- Add all the Deployment Roles-->
					<span ng-repeat="role in _deployment_roles | from:'deployment':deployment | orderBy: 'cohort'">
						<md-button class="md-fab md-primary md-mini" ng-href='#/deployment_roles/{{role.id}}'>
							<md-tooltip md-direction="bottom">
								{{_roles[role.role_id].name}}
							</md-tooltip>
							<md-icon aria-label='{{_roles[role.role_id].icon}}'>{{_roles[role.role_id].icon}}</md-icon>
						</md-button>
					</span>
				</md-tab>

			</md-tabs>

			<md-divider></md-divider>

			<!-- Bind Section -->
			<md-card ng-slide-down='binding[id]' lazy-render layout='column'>
				<md-toolbar flex>
					<section layout='row'>
						<div class="md-toolbar-tools">
							<h2>
								Node Role Binding 
								<md-icon>
									{{_roles[bindRoles[id].role_id].icon}}
								</md-icon>
								{{_roles[bindRoles[id].role_id].name}}
							</h2>
							<span flex></span>
							<md-button class='md-icon-button' ng-click='binding[id]=false'>
								<md-icon>close</md-icon>
								<md-tooltip>
									Stop Binding Node Roles
								</md-tooltip>
							</md-button>
						</div>
					</section>
				</md-toolbar>
				<section layout='row' style='max-height: 400px;'>
					<md-list flex='33' style='overflow-y: auto;'>
						<md-list-item
							class='md-table-toolbar alternate'
							ng-repeat="role in _deployment_roles | from:'deployment':deployment | orderBy: 'cohort'"
							ng-click='setBindRole(id, role.role_id)'
							aria-label='Role'
							md-ink-ripple>
								<span flex>{{_roles[role.role_id].name}}</span>
								<span>
									<md-icon>
										{{_roles[role.role_id].icon}}
									</md-icon>									
								</span>
							<md-divider></md-divider>
						</md-list-item>
					</md-list>
					<md-divider></md-divider>
					<md-list style='overflow-y: auto;' flex='66'>
						<md-list-item
							ng-if='bindRoles[id]'
							ng-repeat="node in _nodes | from:'deployment':deployment | filter:{system: false} | orderBy: 'name'">
							<md-divider></md-divider>

							<!-- Node button -->
							<md-button class="md-fab md-primary md-mini" md-theme="status_{{node.status}}" ng-href="#/nodes/{{node.id}}">
								<md-tooltip md-direction="bottom">
									{{node.status}}
								</md-tooltip>
								<md-icon aria-label='{{node.status}}'>{{icons[node.status]}}</md-icon>
							</md-button>
							<span flex>
								{{node.name}}
							</span>
							<span ng-show='bindRoles[id].roles[node.id]'>
								<md-button class="md-fab md-primary md-mini" md-theme="status_{{bindRoles[id].roles[node.id].status}}" ng-href="#/node_roles/{{bindRoles[id].roles[node.id].id}}">
									<md-icon aria-label='{{bindRoles[id].roles[node.id].status}}'>
										{{icons[bindRoles[id].roles[node.id].status]}}
									</md-icon>
									<md-tooltip>
										{{bindRoles[id].roles[node.id].status}}
									</md-tooltip>
								</md-button>
								<md-button class='md-icon-button' ng-click='destroyNodeRole(bindRoles[id].roles[node.id].id)'>
									<md-icon>delete</md-icon>
									<md-tooltip>
										Destroy Node Role
									</md-tooltip>
								</md-button>
							</span>
							<span ng-hide='bindRoles[id].roles[node.id]'>
								<md-button class='md-icon-button' ng-click='bindNodeRole(id, bindRoles[id].role_id, node.id)'>
									<md-icon>add</md-icon>
									<md-tooltip>
										Bind Node Role
									</md-tooltip>
								</md-button>
							</span>

						</md-list-item>
					</md-list>
				</section>
			</md-card>
			<md-divider ng-show='binding[id]'></md-divider>

			<!-- Toolbar with icons -->
			<md-card-actions layout="row" layout-align="start center">
				<md-button class='md-icon-button' ng-if='deployment.state == -1' ng-click='proposeDeployment(id)'>
					<md-icon>build</md-icon>
					<md-tooltip>Correct</md-tooltip>
				</md-button>

				<md-button class='md-icon-button' ng-if='deployment.state == 0' ng-click='commitDeployment(id)'>
					<md-icon>save</md-icon>
					<md-tooltip>Commit</md-tooltip>
				</md-button>

				<md-menu md-position-mode="target-right target" ng-if='deployment.state == 0' style='padding: 0;'>
					<md-button class='md-icon-button' ng-click='$mdOpenMenu($event)'>
						<md-icon>add_circle</md-icon>
						<md-tooltip>Add Role</md-tooltip>
					</md-button>
					<md-menu-content width="4" >
						<md-menu-item ng-repeat="role in getRoles(id) | filter:{milestone: true} | orderBy:'name'">
							<md-button ng-click="addRole(role.id, id)">
								<div layout="row" flex>
									<p flex>{{role.name}}</p>
									<md-icon md-menu-align-target style="margin: auto 3px auto 0;">{{role.icon}}</md-icon>
								</div>
							</md-button>
						</md-menu-item>
					</md-menu-content>
				</md-menu>

				<md-button class='md-icon-button' ng-if='deployment.state > 0' ng-click='proposeDeployment(id)'>
					<md-icon>mode_edit</md-icon>
					<md-tooltip>Propose</md-tooltip>
				</md-button>


				<md-button class='md-icon-button' ng-click='showAddNodeDialog($event, id)'>
					<md-icon>add_box</md-icon>
					<md-tooltip>Add Node</md-tooltip>
				</md-button>

				<md-button class='md-icon-button' ng-click='binding[id]=!binding[id]'>
					<md-icon>link</md-icon>
					<md-tooltip>Bind Node Roles</md-tooltip>
				</md-button>

				<!-- Right side of toolbar -->
				<md-card-icon-actions layout-align='end center'>
					<md-button class='md-icon-button' ng-click='deleteDeployment($event, id)'>
						<md-icon>delete</md-icon>
						<md-tooltip>Destroy</md-tooltip>
					</md-button>
				</md-card-icon-actions>
			</md-card-actions>

		</section>
</div>

<!-- Floating action button at the bottom right of the screen -->
<div>
	<md-button class='md-fab md-accent md-fab-bottom-right' ng-click='createDeploymentPrompt($event)'>
		<md-icon>add</md-icon>
		<md-tooltip>Create Deployment</md-tooltip>
	</md-button>
</div>